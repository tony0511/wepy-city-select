<!-- åŸå¸‚é€‰æ‹© -->
<template>
  <view class="container citySelect">
    <view class="topView">
      <view class="search">
        <input placeholder="ğŸ” åŸå¸‚åç§°" @input="inputChange" placeholder-style="color: #B8C1CC;" />
      </view>
      <view class="viewTitle">å½“å‰å®šä½åŸå¸‚</view>
      <view class="viewContent">
        <view wx:if="{{localStatus==='success'}}" class="left" @tap="cityChange">
          <text data-type="city" data-code="{{localCode}}" data-name="{{localCity}}">{{localCity}}</text>
          <text class="tip">GPSå®šä½</text>
        </view>
        <view wx:if="{{localStatus==='fail'}}" class="left">
          <text>å®šä½å¤±è´¥</text>
        </view>
        <view wx:if="{{localStatus==='busy'}}" class="left">
          <text>æ­£åœ¨å®šä½</text>
        </view>
        <view wx:if="{{localStatus==='noAuth'}}" class="left">
          <text>å°šæœªå¼€å¯å®šä½æƒé™</text>
        </view>
        <view wx:if="{{localStatus==='fail'}}" class="right" @tap="getLocation">åˆ·æ–°</view>
        <view wx:if="{{localStatus==='busy'}}" class="right">
          <image src="{{picPath}}/spinner.png"></image>
        </view>
        <view wx:if="{{localStatus==='noAuth'}}" class="right" @tap="getLocationRight">å»å¼€å¯</view>
      </view>
    </view>
    <view style="height: 20rpx; width: 100%;"></view>
    <view class="listView" style="height: {{listViewHeight}}px;" @tap="cityChange">
      <scroll-view class="scrollView" scroll-y scroll-into-view="{{toScrolllView}}">
        <view class="hot" id="citySelect_hot">
          <view class="hotTitle">çƒ­é—¨åŸå¸‚</view>
          <view class="hotList">
            <view wx:for="{{hotCityData}}" wx:key="id" class="hotItem" data-type="city" data-code="{{item.id}}" data-name="{{item.name}}">{{item.name}}</view>
          </view>
        </view>
        <!-- å°½é‡å‡å°‘DOMèŠ‚ç‚¹ï¼Œä¸ç„¶ä¼šå½±å“ä½“éªŒæ€§èƒ½ -->
        <block wx:for="{{cityData}}" wx:for-item="oneItem" wx:for-index="oneIndex" wx:key="key">
          <view class="listTitle" id="citySelect_{{oneItem.key}}">{{oneItem.key}}</view>
          <view class="listBody">
            <view class="line"></view>
              <block wx:for="{{oneItem.citys}}" wx:for-item="twoItem" wx:for-index="twoIndex" wx:key="id">
                <view class="content" id="citySelect_{{twoItem.id}}" data-type="city" data-code="{{twoItem.id}}" data-name="{{twoItem.name}}">{{twoItem.name}}
                </view>
                <view class="line itemLine"></view>
              </block>
            <view class="line"></view>
          </view>
        </block>
      </scroll-view>
      <view class="selectBar" @touchend.stop="letterSelect">
        <view class="barItem" data-type="letter" data-letter="hot">çƒ­é—¨</view>
        <view wx:for="{{cityData}}" wx:key="key" class="barItem" data-type="letter" data-letter="{{item.key}}">{{item.key}}</view>
      </view>
    </view>
  </view>
</template>

<script>
  import wepy from 'wepy';

  export default class citySelect extends wepy.page {
    config = { // é¡µé¢é…ç½®
      navigationBarTitleText: 'é€‰æ‹©åŸå¸‚',
    };

    data = {
      picPath: wepy.pic_path, // å›¾ç‰‡æ ¹è·¯å¾„
      listViewHeight: 0, // æ˜¾ç¤ºåŒºåŸŸçš„é«˜åº¦
      cityData: [], // åŸå¸‚åˆ—è¡¨
      hotCityData: [], // çƒ­é—¨åŸå¸‚åˆ—è¡¨
      cityCode: '', // é€‰ä¸­çš„åŸå¸‚code
      localCode: '', // å®šä½çš„åŸå¸‚code
      localCity: '', // å®šä½çš„åŸå¸‚name
      localStatus: 'busy', // å®šä½çŠ¶æ€ busy: æ­£åœ¨å®šä½, success: å®šä½æˆåŠŸ, fail: å®šä½å¤±è´¥, noAuth: æ²¡æœ‰æƒé™
      toScrolllView: '', // æ»šåŠ¨å®šä½åˆ°çš„ä½ç½®idå€¼
      searchTimeId: null, // æœç´¢æ—¶é—´å»¶è¿Ÿid
    };

    methods = {
      inputChange(e) { // è¾“å…¥æŸ¥è¯¢åŸå¸‚
        const value = e.detail.value;
        // console.log(value);
        if (value && !/[^\u4e00-\u9fa5]/.test(value)) {
          const step = () => {
            const lnI = this.cityData.length;
            stopId:for (let i = 0; i < lnI; i++) { // eslint-disable-line
              const citys = this.cityData[i].citys;
              const lnJ = citys.length;
              for (let j = 0; j < lnJ; j++) {
                if (citys[j].name.indexOf(value) > -1) {
                  this.toScrolllView = `citySelect_${citys[j].id}`;
                  this.$apply();
                  break stopId; // eslint-disable-line
                }
              }
            }
          };
          clearTimeout(this.searchTimeId);
          this.searchTimeId = setTimeout(() => { step(); }, 500);
        }
      },
      cityChange(e) { // æ›´æ”¹åŸå¸‚
        console.log('dataset==', e.target.dataset);
        const dataset = e.target.dataset;
        if (dataset.type === 'city') {
          this.$parent.globalData.selectCity = { id: dataset.code, name: dataset.name };
          wepy.navigateBack();
        }
      },
      getLocationRight() { // æœªæˆæƒï¼Œå‘èµ·æˆæƒè¯·æ±‚
        console.log('æœªæˆæƒï¼Œå¾…æˆæƒ==');
        wepy.authorize({ scope: 'scope.userLocation' }).then((response) => {
          this.getLocation();
          console.log(response);
          console.log('æœªæˆæƒ ===> å¾…æˆæƒ');
        }).catch((error) => {
          console.log('promiseé”™è¯¯===', error);
        });
      },
      letterSelect(e) { // å­—æ¯é€‰æ‹©åŸå¸‚
        const dataset = e.target.dataset;
        console.log('letterSelect==', dataset);
        if (dataset.type === 'letter') {
          this.toScrolllView = `citySelect_${dataset.letter}`;
          this.$apply();
          const viewLetter = dataset.letter === 'hot' ? 'çƒ­é—¨' : dataset.letter;
          wepy.showToast({ title: viewLetter, icon: 'none', duration: 1000 });
        }
      },
    };

    getLocation() { // å®šä½åŸå¸‚
      const self = this;
      self.localStatus = 'busy';
      self.$apply();
      wepy.mapsdk.reverseGeocoder({
        success(res) {
          console.log('reverseGeocoder===', res);
          const info = res.result.ad_info;
          self.cityCode = info.adcode;
          self.localCode = info.adcode;
          self.localCity = info.city;
          self.localStatus = 'success';
          self.$apply();
        },
        fail(res) {
          console.log('fail==', res);
          self.localStatus = 'fail';
          wepy.showToast({ title: 'å®šä½å¤±è´¥', icon: 'none', duration: wepy.toastDuration });
          self.$apply();
        },
      });
    }

    onLoad(options) {
      const system = wepy.getSystemInfoSync();
      console.log('getSystemInfoSync==', system);
      // è·å–èŠ‚ç‚¹ä¿¡æ¯
      wepy.createSelectorQuery().select('.topView').fields({ size: true }, (res) => {
        console.log('res===', res);
        // å¯¹éœ€è¦æ»šåŠ¨çš„åŒºåŸŸè·å–éœ€è¦çš„é«˜åº¦
        this.listViewHeight = system.windowHeight - res.height - ((system.windowWidth / 375) * 10);
        this.$apply();
        setTimeout(() => { // å®šä½åŸå¸‚
          // æŸ¥çœ‹æ˜¯å¦æˆæƒ
          wepy.getSetting().then((res) => {
            console.log('getSetting===', res);
            // å·²æœ‰æˆæƒåè·å–ç”¨æˆ·ä¿¡æ¯
            if (res.authSetting['scope.userLocation']) {
              // å·²ç»æˆæƒï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ getLocation è·å–å¤´åƒæ˜µç§°
              this.getLocation();
              console.log('å·²ç»æˆæƒï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨å®šä½');
            } else {
              // æœªæˆæƒï¼Œå‘èµ·æˆæƒè¯·æ±‚
              this.localStatus = 'noAuth';
              this.$apply();
              console.log('æœªæˆæƒï¼Œå¾…æˆæƒ==');
              this.methods.getLocationRight();
            }
          }).catch((error) => {
            console.log('promiseé”™è¯¯===', error);
            wepy.showToast({ title: 'åˆ¤æ–­å®šä½æ˜¯å¦æˆæƒå¤±è´¥ï¼', icon: 'none', duration: this.globalData.duration });
          });
          // å¦‚æœä¹‹å‰å·²æœ‰æ•°æ®åˆ™ä¸ç”¨è¿›è¡Œå†æ¬¡è°ƒç”¨æ¥å£
          const cityData = this.$parent.globalData.cityData;
          const hotCityData = this.$parent.globalData.hotCityData;
          if (cityData.length && hotCityData.length) {
            console.log('yes==');
            this.cityData = cityData;
            this.hotCityData = hotCityData;
          } else {
            this.getCityList();
          }
        }, 0);
      }).exec();
    }
    getCityList() { // è·å–åŸå¸‚åˆ—è¡¨
      const self = this;
      wepy.mapsdk.getCityList({
        success (res) {
          // console.log('city===', res);
          const proList = res.result[0];
          const preCityList = res.result[1];
          // è¿‡æ»¤ä¸éœ€è¦çš„åŸå¸‚åœ°åŒº
          const noUsePro = new Set(['åŒ—äº¬', 'å¤©æ´¥', 'ä¸Šæµ·', 'é‡åº†', 'é¦™æ¸¯', 'æ¾³é—¨']);
          let usePro = [];
          let noUseCityIndex = [];
          let noUseCityIndexSet = new Set([]);
          proList.forEach((item) => {
            if (noUsePro.has(item.name)) {
              usePro.push(item);
              noUseCityIndex.push(item.cidx);
            }
          });
          noUseCityIndex.forEach(item => {
            for (let i = item[0]; i <= item[1]; i++) {
              noUseCityIndexSet.add(i);
            }
          });
          const cityData = [...(preCityList.filter((item, index) => !noUseCityIndexSet.has(index))), ...usePro];
          // çƒ­é—¨åŸå¸‚ç­›é€‰ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€æ·±åœ³ã€å¹¿å·ã€æ­å·ã€æˆéƒ½ã€æ­¦æ±‰
          const hotCityNameSet = new Set(['åŒ—äº¬', 'ä¸Šæµ·', 'æ·±åœ³', 'å¹¿å·', 'æ­å·', 'æˆéƒ½', 'æ­¦æ±‰']);
          self.hotCityData = cityData.filter(item => hotCityNameSet.has(item.name));
          self.$parent.globalData.hotCityData = self.hotCityData;
          const firstLetterSet = new Set([]);
          const cityFormat = [];
          // æ ¼å¼åŒ–æˆéœ€è¦çš„æ•°æ®æ ¼å¼
          cityData.forEach(item => {
            const letter = item.pinyin[0][0].toUpperCase();
            // console.log(letter);
            if (firstLetterSet.has(letter)) {
              cityFormat.find(item => item.key === letter).citys.push(item);
            } else {
              firstLetterSet.add(letter);
              cityFormat.push({ key: letter, citys: [item] });
            }
          });
          // æ ¼å¼åŒ–åçš„åŸå¸‚æ•°æ®åˆ é™¤ä¸éœ€è¦çš„å±æ€§ï¼Œä¸ç„¶ä¼šä¸¥é‡å½±å“æ€§èƒ½ä½“éªŒ
          cityFormat.forEach(item => {
            item.citys.forEach(item => {
              delete item.cidx;
              delete item.location;
              delete item.pinyin;
              delete item.fullname;
            });
          });
          // æ ¼å¼åŒ–åçš„åŸå¸‚æ•°æ®æ’åº
          cityFormat.sort((a, b) => (a.key.charCodeAt(0) - b.key.charCodeAt(0)));
          self.cityData = cityFormat;
          self.$parent.globalData.cityData = cityFormat;
          self.$apply();
          // console.log('getCityList==', res);
          console.log('cityFormat===', cityFormat);
          // console.log('hotCityData===', self.hotCityData);
        },
        fail (res) {
          // console.log('getCityList_fail==', res);
          wepy.showToast({ title: 'è·å–åŸå¸‚åˆ—è¡¨å¤±è´¥', icon: 'none', duration: wepy.toastDuration });
        },
      });
    }
  }
</script>

<style lang="less">
@keyframes rotate
{
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.container{
  &.citySelect{
    >.topView{
      >.search{
        width: 100%;
        height: 71rpx;
        padding-top: 17rpx;
        background-color: #BBC2CA;
        >input{
          width: 718rpx;
          height: 56rpx;
          background-color: #fff;
          border-radius: 28rpx;
          margin: 0 auto;
          text-align: center;
          font-size: 26rpx;
        }
      }
      >.viewTitle{
        padding: 38rpx 34rpx 22rpx;
        line-height: 28rpx;
        font-size: 28rpx;
        color: #8C939D;
      }
      >.viewContent{
        height: 88rpx;
        padding: 0 30rpx 0 34rpx;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: #fff;
        >.left{
          color: #1D2637;
          font-size: 30rpx;
          >.tip{
            color: #8C939D;
            font-size: 26rpx;
            margin-left: 26rpx;
          }
        }
        >.right{
          color: #FEAA0A;
          font-size: 30rpx;
          >image{
            width: 40rpx;
            height: 40rpx;
            animation: rotate 1.5s linear infinite;
          }
        }
      }
    }
    >.listView{
      overflow-y: auto;
      position: relative;
      >.scrollView{
        height: 100%;
        overflow: scroll;
        .hot{
          >.hotTitle{
            line-height: 28rpx;
            padding: 18rpx 30rpx 2rpx;
            color: #8C939D;
            font-size: 28rpx;
          }
          >.hotList{
            padding-left: 12rpx;
            display: flex;
            flex-flow: wrap;
            >.hotItem{
              line-height: 68rpx;
              width: 210rpx;
              text-align: center;
              font-size: 30rpx;
              background-color: #fff;
              margin: 20rpx 0 0 20rpx;
            }
          }
        }
        .listTitle{
          line-height: 20rpx;
          font-size: 28rpx;
          padding: 44rpx 32rpx 22rpx;
          color: #8C939D;
        }
        .listBody{
          background-color: #fff;
          position: relative;
          .line{
            height: 2rpx;
            background: #ccc;
            transform: scaleY(0.5);
            &.itemLine{
              margin-left: 32rpx;
            }
            &:last-child{
              width: 100%;
              position: absolute;
              left: 0;
              bottom: 0;
            }
          }
          > .content{
            line-height: 90rpx;
            padding-left: 32rpx;
            font-size: 30rpx;
            margin-right: 150rpx;
          }
        }
      }
      >.selectBar{
        width: 42rpx;
        height: 95%;
        position: absolute;
        right: 4rpx;
        top: 1%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        >.barItem{
          color: #FEAA0A;
          font-size: 22rpx;
          white-space: nowrap;
          width: 100%;
          text-align: center;
        }
      }
    }
  }
}
</style>
